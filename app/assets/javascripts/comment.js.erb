function add_textarea_expander(field) {
  $(field).TextAreaExpander(100, 1000);
}

function form_has_previously_saved_state(document_number) {
  var stored_state = amplify.store(document_number);
  return  stored_state !== undefined;
}

function previously_saved_form_data(document_number) {
  return amplify.store(document_number);
}

function clear_saved_form_state(document_number) {
  amplify.store(document_number, null);
}
$(function () {

  var comment_form_submission_handler = {
        form: null,
        submit_button: null,

        initialize: function(form) {
          var submission_handler = this;
          
          submission_handler.form = $(form);
          submission_handler.submit_button = submission_handler.form.find('.commit.button');

          return submission_handler;
        },

        submit: function() {
          this.style_submit_button_on_submit();
          this.ajax_submit({type: 'POST'});
        },

        style_submit_button_on_submit: function() {
          this.submit_button.addClass('disabled');
          this.submit_button.find('input').disable().attr('value', 'Submitting Comment');
        },

        success: function(response) {
          var comment_form = $('.ajax-comment-data');
          comment_form.slideUp(400, function() { 
            comment_form.remove();

            var success_page = $('<div>').addClass('ajax-comment-data').html(response);
            success_page.hide();
            $('#flash_message').append( success_page );
            success_page.slideDown(800, function() {
              $('.comment_form_wrapper').closest('div').scrollintoview({duration: 300});                        
            });
          });
          clear_saved_form_state( $('.comment_form_wrapper').data('comment-document-number') );
        },

        error: function(response) {
          $('#comment_wrapper').replaceWith(response.responseText);
          initializeCommentForm();

          $('#comment_wrapper .instructions').scrollintoview({duration: 200});
        },

        ajax_submit: function(options) {
          var submission_handler = this;

          var settings = {
            url: submission_handler.form.attr('action'),
            dataType: 'html',
            type: 'POST',
            data: submission_handler.form.serialize()
          }
          $.extend(settings, options);
          
          $.ajax({
            url: settings.url,
            type: settings.type,
            dataType: settings.dataType,
            data: settings.data,
            success: function(response) {
              submission_handler.success(response);
            },
            error: function(response) {
              submission_handler.error(response);
            }
          });
        }
      };

  var comment_form_load_handler = {
        comment_link: null,
        comment_div: null,
        comment_form: null,
        loading_div: null,
        document_number: null,
        ajax_options: null,

        initialize: function() {
          var form_load_handler = this;

          form_load_handler.comment_link = $('#flash_message.comment a#start_comment');
          form_load_handler.comment_div = $('#flash_message.comment');
          form_load_handler.loading_div = $('<div>').addClass('loading').append(
                                            $('<span>').addClass('loader').html('Loading Comment Form')
                                          );
          form_load_handler.document_number = $('.doc_number').text();

          return form_load_handler;
        },

        ui_trigger_loading: function() {
          this.loading_div.hide();
          this.loading_div.insertAfter( this.comment_div );
          this.loading_div.slideDown(800);
        },

        generate_ajax_options: function() {
          if( this.has_stored_state ) {
            this.ajax_options = {
              url: "/my/articles/" + this.document_number + "/comments/reload",
              type: 'POST',
              data: this.get_stored_state()
            }
          } else {
            this.ajax_options = {url: "/my/articles/" + this.document_number + "/comments/new" };
          }
        },

        has_stored_state: function() {
          return amplify.store(this.document_number) !== undefined;
        },

        get_stored_state: function() {
          return amplify.store(this.document_number);
        },

        load: function() {
          this.ui_trigger_loading();
          this.generate_ajax_options();
          this.ajax_submit();
        },

        ajax_submit: function() {
          var form_load_handler = this;

          var settings = {
            url: '',
            dataType: 'html',
            type: 'GET',
            data: ''
          }
          $.extend(settings, this.ajax_options);

          $.ajax({
            url: settings.url,
            type: settings.type,
            dataType: settings.dataType,
            data: settings.data,
            success: function(response) {
              form_load_handler.success(response);
            },
            error: function(response) {
              form_load_handler.error(response);
            }
          });
        },

        success: function(response) {
          var form_load_handler = this;

          form_load_handler.generate_comment_form(response);
          form_load_handler.comment_div.append( form_load_handler.comment_form );

          /* form must be initialized after it is added to the dom */
          initializeCommentForm();

          form_load_handler.loading_div.slideUp(800, function() {
            $('#flash_message.comment p .button').fadeOut(400);
            form_load_handler.comment_form.slideDown(800);
          });
        },

        error: function() {
          alert('error!');
        },

        generate_comment_form: function(response) {
          this.comment_form = $('<div>').addClass('ajax-comment-data').html(response);
          this.comment_form.hide();
        }
      };


  var commentForm = {
    parseFields: function() {
      var fields = [];
      $('#new_comment .inputs > ol > li').each(function(i,elem) {

        var list_item = $(elem);
        var key = list_item.find('label').text().replace('*','');
        var field = {'label' : key};

        if(list_item.hasClass('stringish')) {
          field.values = [list_item.find('input').val()];
        } else if(list_item.hasClass('text')) {
          field.values = [list_item.find('textarea').val()];
        } else if (list_item.hasClass('select')) {
          var input = $(list_item.find('select').first());
          field.values = [input.find('option[value="' + input.val() + '"]').first().text()];
        } else if (list_item.hasClass('file')) {
          field.values = list_item.find('.attachments tr').map(function (i,elem) {return $(elem).data('name')});
        }

        fields.push(field);
      });
      return fields;
    }
  }

  var initializeCommentForm = function() {
    var renderCommentSummary = function(fields) {
      var source   = $("#comment-summary-template").html();
      var template = Handlebars.compile(source);
      template(fields);
    };

    $('#flash_message.comment').delegate('.comment_preview', 'click', function(event) {
      event.preventDefault();

      var fields = commentForm.parseFields();
      var html   = renderCommentSummary(fields);

      Handlebars.registerPartial('comment_summary', $('#comment-summary-template').html());
      var source   = $("#comment-preview-template").html();
      var template = Handlebars.compile(source);

      var modal = $(template({"fields":fields}));
      $('body').append(modal);
      modal.find(".jqmClose").bind('click', function (event) {
        modal.remove();
      });

      modal.jqm({
          modal: true,
          toTop: true
      });
      modal.jqmShow().centerScreen();
    });

    $('#new_comment li.combo').each(function() {
      var li = $(this);
      var dependencies = li.data('dependencies');
      var input = li.find('input');

      $('#new_comment select[name="comment[' + li.data('dependent-on') + ']"]').change(function() {
        var parent_select = $(this);
        var parent_value = parent_select.val();

        li.find('select').remove();

        if (dependencies[parent_value]) {
          var current_value = input.val();
          var select = $('<select name="' + input.attr('name') + '"><option></option></select>');
          $.map(dependencies[parent_value], function(options) {
            var option = $('<option>').first();
            option.attr('value', options[0]);
            option.text(options[1]);
            select.append(option);
          });
          select.val(current_value);

          input.attr('disabled', 'disabled').hide().val('').after(select);
        } else {
          input.removeAttr('disabled').show();
        }
      }).change();
    });

    if ($('#comment_secret').val() === '') {
      $('#comment_secret').val(Math.random().toString(36).substring(2,16));
    }

    /* initialize local storage of user's form progress */
    var commentFormStore = commentFormStorage.initialize( $('#flash_message .formtastic.comment') );

    var attachedCommentMessage = 'See attached file(s)';
    var commentField = $('#comment_general_comment');
    add_textarea_expander(commentField);

    var container = $('.attachments tbody');
    var existing_attachments = $.parseJSON($('.attachments').data("existing"));
    var clearoutCommentPlaceholder = function (e, data) {
      if(commentField.val() === attachedCommentMessage && container.children('tr:not(.error)').size() === 0) {
        commentField.val('');
      }
    };

    var uploader = $('#fileupload').fileupload({
      url: '/my/comment_attachments',
      autoUpload: true,
      maxNumberOfFiles: <%= Comment::MAX_ATTACHMENTS %>,
      maxFileSize: <%= CommentAttachment::MAX_FILE_SIZE %>,
      acceptFileTypes: /(\.|\/)(<%= CommentAttachment::ALLOWED_EXTENSIONS.join('|')%>)$/i,
      formData: {
        'comment_attachment[secret]': $('#comment_secret').val()
      },
      filesContainer: container,
      prependFiles: true,
      uploadTemplateId: null,
      downloadTemplateId: null,
      uploadTemplate: function (o) {
        var source   = $("#comment-attachment-upload-template").html();
        var template = Handlebars.compile(source);
        return template(o);
      },
      downloadTemplate: function (o) {
        var source   = $("#comment-attachment-complete-template").html();
        var template = Handlebars.compile(source);
        return template(o);
      }
    }).
      bind('fileuploaddestroyed', clearoutCommentPlaceholder).
      bind('fileuploadcompleted', function (e, data) {
        if(commentField.val() === '') {
          commentField.val(attachedCommentMessage);
        }
        /* ensure form gets saved to local store after upload */
        commentFormStore.storeComment();
      }).
      data('fileupload');

    if(uploader) {
      uploader._renderDownload(existing_attachments).appendTo(container);

      clearoutCommentPlaceholder();

      var priorValidations = uploader._hasError;
      uploader._hasError = function(file) {
        container.find('tr').each(function(i,elem){
          if($(elem).data('name') == file.name) {
            file.error = 'A file with the same name has already been attached.'
          }
        });
        return priorValidations.call(this, file);
      };
    }

    /* add public icons where appropriate */
    $('#flash_message .formtastic.comment .inputs li').each(function() {
      var $li = $(this);
      if( $li.hasClass('public') ) {
        $li.find(' > :input').last().after( $('<span>').addClass('public') );
      }
    });

    /* add tipsy for public (world) icon */
    $('.formtastic.comment .inputs span.public').tipsy( {gravity: 's', fallback: "This field will be publically viewable.", fade: true, offset: 4});

    
    /* make the file upload button pretty */
    var add_file_button = $('<div>').addClass('add_file button').text('Add a file');
    $('#fileupload').after( add_file_button );
    $('#flash_message.comment').delegate('.add_file', 'click', function() {
      $('#fileupload').trigger('click');
    });
    $('#fileupload').hide();


    /* add events for max characters in a text field */
    $('#flash_message.comment').delegate('li.input[data-max-size]', 'change', function() {
      enforce_characters_remaining(this);
    });
    $('#flash_message.comment').delegate('li.input[data-max-size]', 'keyup', function() {
      enforce_characters_remaining(this);
    });

    /* add events to clear validation errors */
    $('#flash_message.comment').delegate('li.error.input', 'keyup', function() {
      validate_field(this);
    });
    $('#flash_message.comment').delegate('li.error.input', 'change', function() {
      validate_field(this);
    });

    /* add event to submit for, */
    $('#flash_message').delegate('.formtastic.comment .button.commit:not(.disabled)', 'click', function() {
      $(this).closest('form').submit();
    });

    /* handle form submission */
    $('#flash_message').delegate('.formtastic.comment', 'submit', function(event) {
      event.preventDefault();
      var $form = $(this),
          handler = comment_form_submission_handler.initialize($form);

      handler.submit();
    });

  };

  $('#flash_message.comment').delegate('a.button', 'click', function(event) {
    event.preventDefault();
    var handler = comment_form_load_handler.initialize();

    handler.load();
  });


  $('#flash_message.comment').delegate('a#comment-start-over', 'click', function(event) {
    event.preventDefault();
    
    var document_number = $('.doc_number').text(),
        url = "/my/articles/" + document_number + "/comments/new",
        data = '',
        method = 'GET';
    
    clear_saved_form_state(document_number);

    var comment_form = $('.ajax-comment-data');
    comment_form.slideUp(400, function() { 
      comment_form.remove();

      var comment_div = $('div#flash_message');
      var loading_div = $('<div>').addClass('loading').append(
                            $('<span>').addClass('loader').html('Loading Comment Form')
                        );

      loading_div.hide();
      loading_div.insertAfter( comment_div );
      loading_div.slideDown(800, function() {        
        $.ajax(url, {
          dataType: 'html',
          type: method,
          data: data,
          success: function(data) {
            var comment_form = $('<div>').addClass('ajax-comment-data').html(data);
            comment_form.hide();
            comment_div.append( comment_form );

            loading_div.slideUp(800, function() {
              comment_form.slideDown(800);
            });

            initializeCommentForm();
          },
          error: function() {
            alert('error!');
          }
        });
      });

    });
  });
});
