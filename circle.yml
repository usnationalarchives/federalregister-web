## Customize the test machine
machine:
  ruby:
    version: 1.9.3-p484
  environment:
    RAILS_ENV: test
    RACK_ENV: test
  services:
    - varnish
  hosts:
    www.fr2.local: 127.0.0.1

## Customize dependencies
dependencies:
  pre:
    - npm install -g jshint
    - gem update --system 1.8.25
    - cp config/amazon.yml.sample config/amazon.yml
    - cp config/secrets.yml.sample config/secrets.yml
    - cp config/sendgrid.yml.sample config/sendgrid.yml
    - cd .. && git clone git@github.com:criticaljuncture/fr2
    - cd ../fr2 && git checkout officialness
    - cp ../fr2/config/amazon.yml.sample ../fr2/config/amazon.yml
    - cp ../fr2/config/api_keys.yml.sample ../fr2/config/api_keys.yml
    - cp ../fr2/config/deploy_credentials.yml.sample ../fr2/config/deploy_credentials.yml
    - cp ../fr2/config/mongoid.yml.sample ../fr2/config/mongoid.yml
    - cp ../fr2/config/mysql.yml.sample ../fr2/config/mysql.yml
    - cp ../fr2/config/secrets.yml.sample ../fr2/config/secrets.yml
    - cp ../fr2/config/sendgrid.yml.sample ../fr2/config/sendgrid.yml
    - cp ../fr2/config/test.varnish.yml.sample ../fr2/config/varnish.yml
    - cd ../fr2 && bundle

## Customize database setup commands
database:
  override:
    - 'cd ../fr2 && echo -e "test:\n  host: localhost\n  username: ubuntu\n  database: circle_ruby_fr_test\n  adapter: mysql\n" > config/database.yml'
    - 'cd ../fr2 && bundle exec rake db:create db:schema:load --trace ASSUME_UNITIALIZED_DB=1'
    - 'echo -e "test:\n  host: localhost\n  username: ubuntu\n  database: circle_ruby_myfr_test\n  adapter: mysql2\n" > config/database.yml'
    - 'bundle exec rake db:create db:schema:load'

## Customize test commands
test:
  pre:
    - cd ../fr2 && bundle exec rake db:fixtures:load FIXTURES_PATH=../my_fr2/spec/fixtures/fr2/
    - cd ../fr2 && rake ts:rebuild
    - cd ../fr2 && rake varnish:start
    - cd ../fr2 && script/server -p 3002
    - rails s -p 3001
  override:
    - bundle exec rspec spec
  #post:
  #- bundle exec rake jshint

